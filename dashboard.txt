<?php

// Include the database connection file
require_once "db_connection.php";

// Query to get the 5 most recent posts
$sql = "SELECT * FROM posts ORDER BY created_at DESC LIMIT 5";
$result = $conn->query($sql);

if ($result === false) {
    // Handle error - inform administrator, log to a file, show an error screen, etc.
    echo "Error: " . $conn->error;
} 
function deletePost($postid, $conn){

    // echo "entered function";

    // Prepare the SQL statement
    $stmt = $conn->prepare("DELETE FROM posts WHERE postid = ?");

    // Bind the parameter
    $stmt->bind_param("i", $postid);

    if($stmt->execute()){
        echo "POST DELETED!";
    } else {
        echo "Execute failed: (" . $stmt->errno . ") " . $stmt->error;
    }

    // Execute the query
    // $stmt->execute();

    // Close the statement
    $stmt->close();

    // Close the connection
    // $conn->close();
}

?>

<h3 class="welcome">Hi, <?php echo htmlspecialchars($_SESSION["username"]); ?>. Welcome to our site.</h3>

<div class="wrapper">
    <div class="add-post-box">
        <h2>Add a Post</h2>
        <form action="new_post.php" method="POST">
            <div class="input-box">
                <textarea name="content" id="content" cols="30" rows="2" required></textarea>
                <label for="content">What's on your mind?</label>
            </div>
            <div>
                <button type="submit" class="btn">Post</button>
            </div>
        </form>
    </div>

    <?php
    $sql = "SELECT * FROM posts ORDER BY created_at DESC";
    $result = mysqli_query($conn, $sql);

    while ($row = mysqli_fetch_assoc($result)) {
        echo '<div class="post">';
        echo '<h3>' . htmlspecialchars($row["username"]) . '</h3>';
        echo '<p>' . htmlspecialchars($row["body"]) . '</p>';

        echo '<div class="comment-box">';
        // Fetch comments
        $sql = "SELECT * FROM comments WHERE post_id = ? ORDER BY created_at DESC";
        if ($stmt = mysqli_prepare($conn, $sql)) {
            mysqli_stmt_bind_param($stmt, "i", $param_post_id);

            $param_post_id = $row["id"];

            if (mysqli_stmt_execute($stmt)) {
                $comment_result = mysqli_stmt_get_result($stmt);

                while ($comment_row = mysqli_fetch_assoc($comment_result)) {
                    echo '<div class="comment">';
                    echo '<h4>' . htmlspecialchars($comment_row["username"]) . '</h4>';
                    echo '<p>' . htmlspecialchars($comment_row["body"]) . '</p>';
                    echo '</div>';
                }
            }
        }
        echo '</div>'; // end of comment-box

        echo '<form action="new_comment.php" method="POST">';
        echo '<div class="input-box">';
        echo '<textarea name="comment" id="comment" cols="30" rows="2" required></textarea>';
        echo '<label for="comment">Add a comment...</label>';
        echo '</div>';
        echo '<div>';
        echo '<button type="submit" class="btn">Comment</button>';
        echo '</div>';
        echo '</form>';

        echo '</div>'; // end of post
    }
    ?>

</div> <!-- End of .wrapper -->

<!-- </body>
</html> -->

<?php 
// Close the connection
$conn->close();
?>
              
